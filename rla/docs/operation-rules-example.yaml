# SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Operation Rules Reference Example
#
# ⚠️  This file is REFERENCE DOCUMENTATION ONLY - not loaded automatically at runtime.
#
# Initial Setup (run once per environment):
#   rla rule create --from-yaml docs/operation-rules-example.yaml
#
# Update existing rules (skip existing by default):
#   rla rule create --from-yaml docs/operation-rules-example.yaml
#
# Update existing rules (overwrite mode):
#   rla rule create --from-yaml docs/operation-rules-example.yaml --overwrite
#
# After setup, manage rules via API:
#   rla rule create --name "..." --operation-type power_control --operation power_on --rule-file steps.json
#   rla rule set-default --id <rule-id>
#   rla rule associate --rack-id <rack> --rule-id <rule>
#
# Validate before creating (dry-run):
#   rla rule create --from-yaml docs/operation-rules-example.yaml --dry-run
#
# ═══════════════════════════════════════════════════════════════════════════════

version: v1

rules:
  # ===========================================
  # Power Control - Action-Based with Verification
  # ===========================================
  # NEW FORMAT: Uses PreOperation, MainOperation, PostOperation
  # Includes verification actions for graceful operations

  - name: "Graceful Power On with Verification"
    description: "Power-on with status verification and reachability checks"
    operation_type: power_control
    operation: power_on
    steps:
      # Stage 1: Power shelves first
      - component_type: powershelf
        stage: 1
        max_parallel: 1
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          # Verify power shelf status
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

          # Wait for downstream components (compute, nvlswitch) to become reachable
          - name: VerifyReachability
            timeout: 3m
            poll_interval: 10s
            parameters:
              component_types: ["compute", "nvlswitch"]

          # Additional settle time for hardware stabilization
          - name: Sleep
            parameters:
              duration: 30s

      # Stage 2: NVL switches (parallel batches)
      - component_type: nvlswitch
        stage: 2
        max_parallel: 4
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          # Verify switch status
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

          # Brief settle time
          - name: Sleep
            parameters:
              duration: 15s

      # Stage 3: Compute nodes (larger parallel batches)
      - component_type: compute
        stage: 3
        max_parallel: 8
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          # Verify compute node status
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

  - name: "Graceful Power Off with Verification"
    description: "Power-off with status verification (reverse order)"
    operation_type: power_control
    operation: power_off
    steps:
      # Stage 1: Compute nodes first
      - component_type: compute
        stage: 1
        max_parallel: 8
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

          - name: Sleep
            parameters:
              duration: 10s

      # Stage 2: NVL switches
      - component_type: nvlswitch
        stage: 2
        max_parallel: 4
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

          - name: Sleep
            parameters:
              duration: 5s

      # Stage 3: Power shelves last
      - component_type: powershelf
        stage: 3
        max_parallel: 1
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        # Pre-operation: Allow time for downstream to fully shut down
        pre_operation:
          - name: Sleep
            parameters:
              duration: 30s

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

  # ===========================================
  # Forceful Operations - Fast with Final Verification
  # ===========================================
  # Forceful operations skip intermediate verification for speed
  # but verify final state in a separate stage

  - name: "Force Power On with Final Verification"
    description: "Fast power-on, verify all components at the end"
    operation_type: power_control
    operation: force_power_on
    steps:
      # Stage 1: Power shelves (no verification)
      - component_type: powershelf
        stage: 1
        max_parallel: 0  # All at once
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 30s

      # Stage 2: NVL switches (no verification)
      - component_type: nvlswitch
        stage: 2
        max_parallel: 0  # All at once
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 15s

      # Stage 3: Compute nodes (no verification)
      - component_type: compute
        stage: 3
        max_parallel: 0  # All at once
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 10s

      # Stage 4: FINAL VERIFICATION (all component types in parallel)
      - component_type: powershelf
        stage: 4
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "on"

      - component_type: nvlswitch
        stage: 4  # Parallel with powershelf
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "on"

      - component_type: compute
        stage: 4  # Parallel with others
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "on"

  - name: "Force Power Off with Final Verification"
    description: "Fast power-off, verify all components at the end"
    operation_type: power_control
    operation: force_power_off
    steps:
      # Stage 1: Compute nodes (no verification)
      - component_type: compute
        stage: 1
        max_parallel: 0
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 10s

      # Stage 2: NVL switches (no verification)
      - component_type: nvlswitch
        stage: 2
        max_parallel: 0
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 5s

      # Stage 3: Power shelves (no verification)
      - component_type: powershelf
        stage: 3
        max_parallel: 0
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: Sleep
            parameters:
              duration: 10s

      # Stage 4: FINAL VERIFICATION (all component types in parallel)
      - component_type: powershelf
        stage: 4
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "off"

      - component_type: nvlswitch
        stage: 4  # Parallel with powershelf
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "off"

      - component_type: compute
        stage: 4  # Parallel with others
        max_parallel: 0
        timeout: 2m
        retry:
          max_attempts: 2
          initial_interval: 5s
          backoff_coefficient: 1.5

        main_operation:
          name: VerifyPowerStatus
          timeout: 1m
          poll_interval: 5s
          parameters:
            expected_status: "off"

  # ===========================================
  # Restart Operations
  # ===========================================

  - name: "Graceful Restart with Verification"
    description: "Restart with verification at each stage"
    operation_type: power_control
    operation: restart
    steps:
      # === POWER OFF SEQUENCE (Stages 1-3) ===

      # Stage 1: Compute off
      - component_type: compute
        stage: 1
        max_parallel: 8
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

      # Stage 2: NVL switches off
      - component_type: nvlswitch
        stage: 2
        max_parallel: 4
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

      # Stage 3: Power shelves off
      - component_type: powershelf
        stage: 3
        max_parallel: 1
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "off"

          # Brief pause between off and on
          - name: Sleep
            parameters:
              duration: 10s

      # === POWER ON SEQUENCE (Stages 4-6) ===

      # Stage 4: Power shelves on
      - component_type: powershelf
        stage: 4
        max_parallel: 1
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

          - name: VerifyReachability
            timeout: 3m
            poll_interval: 10s
            parameters:
              component_types: ["compute", "nvlswitch"]

          - name: Sleep
            parameters:
              duration: 30s

      # Stage 5: NVL switches on
      - component_type: nvlswitch
        stage: 5
        max_parallel: 4
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

          - name: Sleep
            parameters:
              duration: 15s

      # Stage 6: Compute nodes on
      - component_type: compute
        stage: 6
        max_parallel: 8
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

        main_operation:
          name: PowerControl

        post_operation:
          - name: VerifyPowerStatus
            timeout: 30s
            poll_interval: 5s
            parameters:
              expected_status: "on"

  # ===========================================
  # Firmware Control Operations
  # ===========================================

  - name: "Default Firmware Upgrade"
    description: "Parallel firmware upgrade across all component types"
    operation_type: firmware_control
    operation: upgrade
    steps:
      # All component types can upgrade in parallel (Stage 1)
      - component_type: compute
        stage: 1
        max_parallel: 4  # Batch size
        timeout: 45m
        retry:
          max_attempts: 2
          initial_interval: 30s
          backoff_coefficient: 1.5

        main_operation:
          name: FirmwareControl

      - component_type: nvlswitch
        stage: 1  # Parallel with compute
        max_parallel: 2
        timeout: 45m
        retry:
          max_attempts: 2
          initial_interval: 30s
          backoff_coefficient: 1.5

        main_operation:
          name: FirmwareControl

      - component_type: powershelf
        stage: 1  # Parallel with others
        max_parallel: 1
        timeout: 45m
        retry:
          max_attempts: 2
          initial_interval: 30s
          backoff_coefficient: 1.5

        main_operation:
          name: FirmwareControl

  # ===========================================
  # LEGACY FORMAT EXAMPLES (Backward Compatibility)
  # ===========================================
  # These rules use the old format without action-based configuration
  # Included for reference and backward compatibility testing

  - name: "Legacy Power On (No Actions)"
    description: "Old format using delay_after instead of actions"
    operation_type: power_control
    operation: power_on
    steps:
      - component_type: powershelf
        stage: 1
        max_parallel: 1
        delay_after: 30s  # Legacy field
        timeout: 10m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

      - component_type: nvlswitch
        stage: 2
        max_parallel: 4
        delay_after: 15s  # Legacy field
        timeout: 15m
        retry:
          max_attempts: 3
          initial_interval: 5s
          backoff_coefficient: 2.0

      - component_type: compute
        stage: 3
        max_parallel: 8
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 1s
          backoff_coefficient: 2.0

# ═══════════════════════════════════════════════════════════════════════════════
# ACTION REFERENCE
# ═══════════════════════════════════════════════════════════════════════════════
#
# Available Actions:
#
# 1. PowerControl
#    - Main operation for power on/off/restart
#    - No required parameters
#    - Uses operation context from task
#
# 2. VerifyPowerStatus
#    - Polls until expected power status is reached
#    - Required parameters:
#      - expected_status: "on" or "off"
#    - Required fields:
#      - timeout: Maximum time to wait (e.g., "30s", "2m")
#      - poll_interval: Time between polls (e.g., "5s")
#
# 3. VerifyReachability
#    - Polls until specified component types become reachable
#    - Required parameters:
#      - component_types: Array of strings ["compute", "nvlswitch", "powershelf"]
#    - Required fields:
#      - timeout: Maximum time to wait
#      - poll_interval: Time between polls
#
# 4. Sleep
#    - Pauses execution for specified duration
#    - Required parameters:
#      - duration: Time to sleep (e.g., "5s", "30s", "2m")
#    - Implemented as workflow.Sleep() (not an activity)
#
# 5. FirmwareControl
#    - Main operation for firmware upgrade/downgrade/rollback
#    - No required parameters
#    - Uses operation context from task
#
# 6. GetPowerStatus
#    - Query current power status of components
#    - Returns map of component IDs to power status
#    - No required parameters
#
  # ===========================================
  # Bring-Up - Rack Bring-Up Sequence
  # ===========================================
  # Stage 1: PowerShelf — wait PMC ready, turn on PSUs, verify
  # Stage 2: Compute    — open gate, wait bring-up, verify,
  #                        reboot, verify again
  #
  # Bring-up specific actions:
  #   WaitPMCReady   — poll PSM until all PMCs are reachable
  #   AllowBringUp   — open Carbide power-on gate
  #   WaitBringUp    — poll Carbide until ingestion complete

  - name: Default Rack Bring-Up
    description: >
      Standard rack bring-up sequence.
    operation_type: bring_up
    operation: bring_up
    steps:
      # === Stage 1: PowerShelf ===
      - component_type: powershelf
        stage: 1
        max_parallel: 0
        timeout: 20m
        retry:
          max_attempts: 3
          initial_interval: 10s
          backoff_coefficient: 2.0
        pre_operation:
          - name: WaitPMCReady
            timeout: 10m
            poll_interval: 30s
        main_operation:
          name: PowerControl
        post_operation:
          - name: VerifyPowerStatus
            timeout: 5m
            poll_interval: 10s
            parameters:
              expected_status: "on"

      # === Stage 2: Compute ===
      - component_type: compute
        stage: 2
        max_parallel: 0
        timeout: 30m
        retry:
          max_attempts: 3
          initial_interval: 10s
          backoff_coefficient: 2.0
        pre_operation:
          - name: AllowBringUp
          - name: WaitBringUp
            timeout: 15m
            poll_interval: 30s
          - name: VerifyPowerStatus
            timeout: 10m
            poll_interval: 15s
            parameters:
              expected_status: "on"
        main_operation:
          name: PowerControl
          parameters:
            operation: "force_restart"
        post_operation:
          - name: Sleep
            parameters:
              duration: 30s
          - name: VerifyPowerStatus
            timeout: 10m
            poll_interval: 15s
            parameters:
              expected_status: "on"

# ═══════════════════════════════════════════════════════════════════════════════
# BEST PRACTICES
# ═══════════════════════════════════════════════════════════════════════════════
#
# Graceful Operations:
#   - Use verification in post_operation to confirm success
#   - Include VerifyPowerStatus after PowerControl
#   - Add VerifyReachability after powershelf power-on
#   - Use appropriate timeouts for verification (30s-3m typical)
#
# Forceful Operations:
#   - Skip intermediate verification for speed
#   - Add final verification stage at the end
#   - Verify all component types in parallel in final stage
#   - Use shorter verification timeouts (1-2m typical)
#
# Restart Operations:
#   - Verify status="off" in power-off sequence
#   - Verify status="on" in power-on sequence
#   - Add pause between off and on sequences
#
# Performance Tuning:
#   - Adjust max_parallel for your hardware capacity
#   - Increase poll_interval for slow hardware
#   - Use longer timeouts for unreliable BMCs
#   - Remove verification for maximum speed (forceful operations)
#
# Reliability:
#   - Set appropriate retry policies (2-3 attempts typical)
#   - Use exponential backoff (coefficient 1.5-2.0)
#   - Longer initial_interval for slow operations
#   - Always verify critical operations (power shelf, switches)
