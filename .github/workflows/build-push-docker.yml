# SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary
#
# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.

name: Build and Push Docker Images

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner type for the build jobs"
        required: false
        default: "ubuntu-latest"
        type: string
      semantic_version:
        description: "Semantic version from VERSION file"
        required: true
        type: string
      short_sha:
        description: "Short SHA for tagging"
        required: true
        type: string
      branch_sha_tag:
        description: "Combined branch name and short SHA tag (branchname-sha)"
        required: true
        type: string
      target_registry:
        description: "Target NVCR registry path"
        required: true
        type: string
      push_enabled:
        description: "Whether to push images to registry"
        required: false
        default: true
        type: boolean
      branch_name:
        description: "Sanitized branch name for image tags"
        required: true
        type: string
      is_main_branch:
        description: "Whether to push 'latest' and version tags (only on main) - pass 'true' or 'false' as string"
        required: false
        default: "false"
        type: string
    secrets:
      NVCR_USERNAME:
        description: "NVIDIA Container Registry username (typically '$oauthtoken')"
        required: false
      NVCR_TOKEN:
        description: "NVIDIA Container Registry API token"
        required: false

# Required secrets (must be configured in GitHub repository settings):
# - NVCR_USERNAME: NVIDIA Container Registry username (typically '$oauthtoken')
# - NVCR_TOKEN: NVIDIA Container Registry API token
#
# To configure secrets:
# 1. Go to your GitHub repository settings
# 2. Navigate to Secrets and variables > Actions
# 3. Click "New repository secret"
# 4. Add the following secrets:
#    - Name: NVCR_USERNAME
#      Value: $oauthtoken (or your NVCR username)
#    - Name: NVCR_TOKEN
#      Value: Your NVIDIA NGC API token (get from https://ngc.nvidia.com/)

jobs:
  # Build and push carbide-rest-api
  build-carbide-rest-api:
    name: Build carbide-rest-api
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-api
      binary_name: api
      binary_path: /app/api
      dockerfile: ./docker/production/Dockerfile.carbide-rest-api
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build and push carbide-rest-db
  build-carbide-rest-db:
    name: Build carbide-rest-db
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-db
      binary_name: migrations
      binary_path: /app/migrations
      dockerfile: ./docker/production/Dockerfile.carbide-rest-db
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build and push carbide-rest-site-manager
  build-carbide-rest-site-manager:
    name: Build carbide-rest-site-manager
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-site-manager
      binary_name: sitemgr
      binary_path: /app/sitemgr
      dockerfile: ./docker/production/Dockerfile.carbide-rest-site-manager
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build and push carbide-rest-workflow
  build-carbide-rest-workflow:
    name: Build carbide-rest-workflow
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-workflow
      binary_name: workflow
      binary_path: /app/workflow
      dockerfile: ./docker/production/Dockerfile.carbide-rest-workflow
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build and push carbide-rest-site-agent
  build-carbide-rest-site-agent:
    name: Build carbide-rest-site-agent
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-site-agent
      binary_name: elektra
      binary_path: /app/elektra
      dockerfile: ./docker/production/Dockerfile.carbide-rest-site-agent
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build and push carbide-rest-cert-manager
  build-carbide-rest-cert-manager:
    name: Build carbide-rest-cert-manager
    uses: ./.github/workflows/build-push-service.yml
    with:
      runner: ${{ inputs.runner }}
      service_name: carbide-rest-cert-manager
      binary_name: credsmgr
      binary_path: /app/credsmgr
      dockerfile: ./docker/production/Dockerfile.carbide-rest-cert-manager
      semantic_version: ${{ inputs.semantic_version }}
      short_sha: ${{ inputs.short_sha }}
      branch_sha_tag: ${{ inputs.branch_sha_tag }}
      target_registry: ${{ inputs.target_registry }}
      push_enabled: ${{ inputs.push_enabled }}
      is_main_branch: ${{ inputs.is_main_branch }}
    secrets: inherit

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ${{ inputs.runner }}
    needs:
      - build-carbide-rest-api
      - build-carbide-rest-db
      - build-carbide-rest-site-manager
      - build-carbide-rest-workflow
      - build-carbide-rest-site-agent
      - build-carbide-rest-cert-manager
    if: always()
    outputs:
      build_artifacts: ${{ steps.aggregate.outputs.artifacts }}

    steps:
      - name: Generate build summary
        run: |
          echo "# Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic Version**: \`${{ inputs.semantic_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Git SHA**: \`${{ inputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch-SHA Tag**: \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ inputs.target_registry }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Push Enabled**: \`${{ inputs.push_enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Is Main Branch**: \`${{ inputs.is_main_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref Name**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`linux/amd64, linux/arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.push_enabled }}" = "false" ]; then
            echo "> **Note**: Images were built but NOT pushed to registry (build-only mode)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "## Docker Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "All images tagged with: \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Main branch additional tags:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ inputs.semantic_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Images Built" >> $GITHUB_STEP_SUMMARY
          echo "1. \`carbide-rest-api:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "2. \`carbide-rest-db:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "3. \`carbide-rest-site-manager:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "4. \`carbide-rest-workflow:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "5. \`carbide-rest-site-agent:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "6. \`carbide-rest-cert-manager:${{ inputs.branch_sha_tag }}\` (amd64 + arm64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.is_main_branch }}" = "true" ] || [ "${{ github.ref_name }}" = "main" ]; then
            echo "## Binary Artifacts Uploaded (Main Branch)" >> $GITHUB_STEP_SUMMARY
            echo "Each binary uploaded for both amd64 and arm64 with versions: \`${{ inputs.semantic_version }}\`, \`latest\`, \`${{ inputs.branch_sha_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-api: \`${{ needs.build-carbide-rest-api.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-db: \`${{ needs.build-carbide-rest-db.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-site-manager: \`${{ needs.build-carbide-rest-site-manager.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-workflow: \`${{ needs.build-carbide-rest-workflow.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-site-agent: \`${{ needs.build-carbide-rest-site-agent.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- carbide-rest-cert-manager: \`${{ needs.build-carbide-rest-cert-manager.result }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Aggregate outputs
        id: aggregate
        run: |
          # Create JSON array of artifacts
          # We use a temporary file to handle potential quoting issues and then read it into the variable
          cat <<EOF > artifacts.json
          [
            {
              "service": "carbide-rest-api",
              "image_ref": "${{ needs.build-carbide-rest-api.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-api.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-api.outputs.ngc_image_resource }}"
            },
            {
              "service": "carbide-rest-db",
              "image_ref": "${{ needs.build-carbide-rest-db.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-db.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-db.outputs.ngc_image_resource }}"
            },
            {
              "service": "carbide-rest-site-manager",
              "image_ref": "${{ needs.build-carbide-rest-site-manager.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-site-manager.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-site-manager.outputs.ngc_image_resource }}"
            },
            {
              "service": "carbide-rest-workflow",
              "image_ref": "${{ needs.build-carbide-rest-workflow.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-workflow.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-workflow.outputs.ngc_image_resource }}"
            },
            {
              "service": "carbide-rest-site-agent",
              "image_ref": "${{ needs.build-carbide-rest-site-agent.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-site-agent.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-site-agent.outputs.ngc_image_resource }}"
            },
            {
              "service": "carbide-rest-cert-manager",
              "image_ref": "${{ needs.build-carbide-rest-cert-manager.outputs.image_ref }}",
              "binary_resource": "${{ needs.build-carbide-rest-cert-manager.outputs.ngc_binary_resource }}",
              "image_resource": "${{ needs.build-carbide-rest-cert-manager.outputs.ngc_image_resource }}"
            }
          ]
          EOF

          # Compact JSON and set as output
          ARTIFACTS=$(jq -c . artifacts.json)
          echo "artifacts=$ARTIFACTS" >> $GITHUB_OUTPUT
