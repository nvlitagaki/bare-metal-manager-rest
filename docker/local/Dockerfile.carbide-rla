# Build stage
FROM --platform=$BUILDPLATFORM golang:1.25.4 AS builder

# Docker automatically provides these args during multi-platform builds
ARG TARGETOS=linux
ARG TARGETARCH=amd64

# Set environment variables for cross-compilation
ENV CGO_ENABLED=0
ENV GOOS=$TARGETOS
ENV GOARCH=$TARGETARCH

ENV GIT_TERMINAL_PROMPT=1
RUN go env

ARG skipcache=0

WORKDIR /workspace
# Copy go module files and VERSION first for better caching
COPY go.mod go.sum VERSION ./
RUN go mod download

COPY rla/ ./rla/

WORKDIR /workspace/rla

# Fetch and cache dependencies.  This should mainly be for if we start including other private repos in the build.
#RUN --mount=type=secret,id=gitcreds,dst=/root/.netrc go mod download

# Build with version information injected via ldflags
RUN VERSION=$(cat /workspace/VERSION 2>/dev/null || echo "dev") && \
    BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ") && \
    GIT_COMMIT=${CI_COMMIT_SHORT_SHA:-$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")} && \
    go build -ldflags "-extldflags '-static' \
    -X 'github.com/nvidia/bare-metal-manager-rest/rla/pkg/metadata.Version=${VERSION}' \
    -X 'github.com/nvidia/bare-metal-manager-rest/rla/pkg/metadata.BuildTime=${BUILD_TIME}' \
    -X 'github.com/nvidia/bare-metal-manager-rest/rla/pkg/metadata.GitCommit=${GIT_COMMIT}'" \
    -o /app/rla \
    .

FROM nvcr.io/nvidia/distroless/go:v3.2.1 AS final

COPY --from=builder --chown=nvs:nvs /app/rla /app/rla

USER nvs

EXPOSE 50051

ENTRYPOINT ["/app/rla", "serve"]
